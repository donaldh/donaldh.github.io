{
  "name": "donaldh.github.io",
  "tagline": "",
  "body": "# Embedding Perl 6 in Eclipse \r\n\r\n**[Coke]** asked me a simple [question](http://irclog.perlgeek.de/perl6/2014-06-16#i_8878227) on irc:\r\n\r\n> donaldh: have you any idea how to bundle perl6 in a jar we could invoke from eclipse?\r\n\r\nThis tickled my urge to explore embedding Rakudo / JVM, to refresh my knowledge of Eclipse and also to have some fun hacking with Perl 6.\r\n\r\nIt turns out that embedding the Rakudo runtime in an Eclipse plugin was fairly straightforward. The two challenges were:\r\n\r\n1. Getting module loading to work\r\n2. Fixing class loading issues\r\n\r\n### Fixing Module Loading\r\n\r\nThis was the biggest challenge. Both nqp and rakudo rely on the Java classpath for bootstrapping themselves with essential infrastructure such as the ModuleLoader and CORE.setting. Unfortunately an eclipse bundle has a single jar in the classpath so an alternative approach needs to be used. I've long wanted to decouple module loading from the classpath anyway so this provided the ideal opportunity to prototype an approach.\r\n\r\nAt the moment I have just *faked* it by extending nqp::jvmclasspath to return an extended classpath that includes\r\n\r\n* perl6.prefix/languages/nqp/lib\r\n* perl6.prefix/languages/perl6/lib\r\n* perl6.prefix/languages/perl6/runtime\r\n\r\n*perl6.prefix* is derived from the Eclipse bundle location and the complete rakudo installation is actually embedded inside the bundle.\r\n\r\nThe real solution will be to completely separate the module search path from the java classpath. I think we could use the module-path from nqp, perhaps with a Java system property as an alternative setting mechanism. It will need to support a list of paths for bootstrap time and should be derivable from perl6.prefix when that is all that has been set.\r\n\r\n### Fixing Class Loading Issues\r\n\r\nThis turned out to be simpler that I was expecting. When you have multiple class loaders and you have OSGi package imports and exports, then you expect to have a hard time resolving class loading issues. But, with the rakudo runtime jars already added to the Bundle-ClassPath, the only remaining issue was that classes loaded by one ClassLoader could not find classes loaded by other ClassLoaders. The simple fix was to modify LibraryLoader and ByteClassLoader to use the bundle classloader as their parent so they can delegate to it.\r\n\r\n### Trying It Out\r\n\r\nIf you want to try this out, you first need to build and install nqp on the jvm backend, using the **classloading** branch, then build and install rakudo.\r\n\r\nThen:\r\n```\r\n$ git clone git@github.com:donaldh/perl6-eclipse-plugin.git\r\n$ git clone git@github.com:donaldh/perl6-editor.git\r\n$ cp -r `perl6 -e \"say $*VM.prefix\"` perl6-eclipse-plugin\r\n```\r\nYou can now:\r\n\r\n1. Import these two plugin projects into Eclipse\r\n2. Build the plugins\r\n3. Launch a debug Eclipse that contains these two plugins \r\n\r\n![Eclipse screen shot](/assets/perl6embed.png)\r\n\r\n## Next Steps\r\n\r\n1. Improve eval performance by retaining a global context and compilation unit.\r\n2. Use the Perl 6 grammar and resulting ast for syntax highlighting.\r\n3. Explore embedding Perl 6 into the [EPIC Editor](http://www.epic-ide.org/)\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}